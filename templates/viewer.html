<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
            display: flex;
            gap: 30px;
        }

        .sidebar {
            width: 280px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 100px;
        }

        .sidebar-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e9ecef;
        }

        .toc-list {
            list-style: none;
        }

        .toc-item {
            margin-bottom: 8px;
        }

        .toc-link {
            color: #6c757d;
            text-decoration: none;
            display: block;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .toc-link:hover {
            background: #f8f9fa;
            color: #667eea;
        }

        .toc-link.active {
            background: #667eea;
            color: white;
        }

        .content-area {
            flex: 1;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 40px;
            min-height: 800px;
        }

        /* Ensure anchored headings do not hide beneath the sticky header */
        .content-area h1,
        .content-area h2,
        .content-area h3,
        .content-area h4,
        .content-area h5,
        .content-area h6 {
            scroll-margin-top: 100px; /* approx sticky header height + spacing */
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 400px;
            font-size: 1.2rem;
            color: #6c757d;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1024px) {
            .main-content {
                flex-direction: column;
            }

            .sidebar {
                width: 100%;
                position: static;
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 15px;
            }

            .header-actions {
                width: 100%;
                justify-content: center;
            }

            .main-content {
                padding: 20px;
            }

            .content-area {
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-file-pdf"></i> Document Viewer
            </div>
            <div class="header-actions">
                <a href="/" class="btn secondary">
                    <i class="fas fa-home"></i> Home
                </a>
                <a href="/edit/{{ unique_id }}" class="btn" id="editBtnViewer">
                    <i class="fas fa-edit"></i> Edit Document
                </a>
                <div class="btn secondary" id="optionsBtn">
                    <i class="fas fa-ellipsis-v"></i> Options
                </div>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="sidebar">
            <div class="sidebar-title">
                <i class="fas fa-list"></i> Table of Contents
            </div>
            <ul class="toc-list" id="toc-list">
                <li class="toc-item">
                    <div class="loading">
                        <div class="spinner"></div>
                        Loading...
                    </div>
                </li>
            </ul>
        </div>

        <div class="content-area">
            <div class="loading" id="content-loading">
                <div class="spinner"></div>
                Loading document...
            </div>
            <div id="document-content" style="display: none;"></div>
        </div>
    </div>

    <script>
        // Options menu
        (function(){
            const btn = document.getElementById('optionsBtn');
            if (!btn) return;
            const menu = document.createElement('div');
            menu.style.position = 'absolute';
            menu.style.right = '30px';
            menu.style.top = '60px';
            menu.style.background = '#fff';
            menu.style.border = '1px solid #e9ecef';
            menu.style.borderRadius = '8px';
            menu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.08)';
            menu.style.padding = '8px 0';
            menu.style.display = 'none';
            menu.style.minWidth = '180px';
            menu.style.zIndex = '2000';
            menu.innerHTML = `
                <a href="#" id="downloadLink" style="display:block; padding:10px 16px; color:#2c3e50; text-decoration:none;"><i class="fas fa-download"></i> Download</a>
                <a href="#" id="shareLink" style="display:block; padding:10px 16px; color:#2c3e50; text-decoration:none;"><i class="fas fa-share"></i> Share</a>
                <a href="#" id="deleteLink" style="display:block; padding:10px 16px; color:#dc3545; text-decoration:none;"><i class="fas fa-trash"></i> Delete</a>
            `;
            document.body.appendChild(menu);
            btn.addEventListener('click', () => {
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            });
            document.addEventListener('click', (e) => {
                if (!btn.contains(e.target) && !menu.contains(e.target)) menu.style.display = 'none';
            });
            document.getElementById('shareLink').addEventListener('click', async (e) => {
                e.preventDefault();
                const url = window.location.origin + '/view/{{ unique_id }}?share=1';
                try {
                    await navigator.clipboard.writeText(url);
                    alert('View link copied to clipboard');
                } catch { alert(url); }
                menu.style.display = 'none';
            });
            document.getElementById('deleteLink').addEventListener('click', async (e) => {
                e.preventDefault();
                if (!confirm('Delete this document? This cannot be undone.')) return;
                try {
                    const tok = document.getElementById('deleteLink').getAttribute('data-token') || '';
                    const res = await fetch(`/api/delete/{{ unique_id }}?token=${encodeURIComponent(tok)}`, { method: 'DELETE' });
                    const json = await res.json();
                    if (json.success) { window.location.href = '/'; } else { alert(json.error || 'Delete failed'); }
                } catch { alert('Delete failed'); }
            });
        })();

        const uniqueId = '{{ unique_id }}';
        const isShared = new URLSearchParams(location.search).get('share') === '1';
        if (isShared) {
            const eb = document.getElementById('editBtnViewer');
            if (eb) eb.style.display = 'none';
            const dl = document.getElementById('downloadLink');
            if (dl) dl.style.display = 'none';
            const opt = document.getElementById('optionsBtn');
            if (opt) opt.style.display = 'none';
            const home = document.querySelector('.header-actions a[href="/"]');
            if (home) home.style.display = 'none';
        }
        const tocList = document.getElementById('toc-list');
        const contentLoading = document.getElementById('content-loading');
        const documentContent = document.getElementById('document-content');

        // Helper: generate slug from heading text for IDs
        function slugify(text) {
            return (text || '')
                .toString()
                .toLowerCase()
                .trim()
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-');
        }

        // Secure links: fetch edit/download token when not shared
        (async function secureLinks(){
            try {
                if (isShared) return;
                const res = await fetch(`/api/token/${uniqueId}`);
                const data = await res.json();
                if (data && data.token) {
                    const eb = document.getElementById('editBtnViewer');
                    if (eb) eb.href = `/edit/${uniqueId}?token=${encodeURIComponent(data.token)}`;
                    const dl = document.getElementById('downloadLink');
                    if (dl) dl.href = `/download/${uniqueId}?token=${encodeURIComponent(data.token)}`;
                    const del = document.getElementById('deleteLink');
                    if (del) del.setAttribute('data-token', data.token);
                }
            } catch(e) { /* ignore */ }
        })();

        // Load the document content
        async function loadDocument() {
            try {
                const response = await fetch(`/api/content/${uniqueId}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Extract the content from the HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.content, 'text/html');
                
                // Extract main content
                const mainContent = doc.querySelector('.main-content');
                if (mainContent) {
                    documentContent.innerHTML = mainContent.innerHTML;
                } else {
                    documentContent.innerHTML = data.content;
                }

                // Show content
                contentLoading.style.display = 'none';
                documentContent.style.display = 'block';
                // Clear TOC loading state immediately
                tocList.innerHTML = '';

                // For shared view: set header title to document title and provide an Open button only
                if (isShared) {
                    let docTitle = '';
                    try {
                        const headTitle = (doc.querySelector('title') && doc.querySelector('title').textContent) || '';
                        const firstH1 = (documentContent.querySelector('h1') && documentContent.querySelector('h1').textContent) || '';
                        docTitle = (firstH1 || headTitle || 'Document').trim();
                    } catch (_) { docTitle = 'Document'; }
                    const logo = document.querySelector('.logo');
                    if (logo) logo.innerHTML = `<i class="fas fa-file-pdf"></i> ${docTitle}`;
                    const actions = document.querySelector('.header-actions');
                    if (actions) {
                        // remove all children then add just Open button
                        actions.innerHTML = '';
                        const openBtn = document.createElement('a');
                        openBtn.href = '#';
                        openBtn.className = 'btn';
                        openBtn.innerHTML = '<i class="fas fa-folder-open"></i> Open';
                        openBtn.addEventListener('click', (e)=>{
                            e.preventDefault();
                            const header = document.querySelector('.header');
                            const headerH = header ? header.offsetHeight : 0;
                            const y = document.querySelector('.content-area').getBoundingClientRect().top + window.scrollY - headerH - 10;
                            window.scrollTo({ top: y, behavior: 'smooth' });
                        });
                        actions.appendChild(openBtn);
                    }
                }

                // Build TOC from the displayed content to ensure IDs exist and link properly
                (function buildDisplayedTOC(){
                    try {
                        const tocItems = [];
                        const scope = documentContent;
                        const numberPrefixRe = /^\s*\d+(?:\.\d+)*[).]?\s+/;
                        const candidates = Array.from(scope.querySelectorAll('h1,h2,h3,h4,h5,h6,p,li,div'))
                            .filter(el => numberPrefixRe.test((el.textContent || '').trim()))
                            .filter(el => (el.textContent || '').trim().length <= 200);
                        let list = candidates.length > 0 ? candidates : Array.from(scope.querySelectorAll('h1'));
                        if (list.length === 0) {
                            // last-resort fallback: any heading
                            list = Array.from(scope.querySelectorAll('h2,h3'));
                        }
                        list.forEach((el, index) => {
                            const text = (el.textContent || '').trim();
                            if (!text) return;
                            if (!el.id) {
                                let base = slugify(text);
                                // Ensure ID doesn't start with a digit (problematic for CSS selectors)
                                if (/^[0-9]/.test(base)) base = `s-${base}`;
                                let id = base || `section-${index+1}`;
                                let counter = 2;
                                while (document.getElementById(id)) { id = `${base}-${counter++}`; }
                                el.id = id;
                            }
                            tocItems.push({ href: `#${el.id}`, text, index });
                        });
                        tocList.innerHTML = '';
                        if (tocItems.length === 0) {
                            tocList.innerHTML = '<li class="toc-item" style="color:#6c757d;">No sections found</li>';
                            return;
                        }
                        tocItems.forEach(item => {
                            const li = document.createElement('li');
                            li.className = 'toc-item';
                            li.innerHTML = `<a href="${item.href}" class="toc-link" data-target="${item.href}">${item.text}</a>`;
                            tocList.appendChild(li);
                        });
                        // Smooth scrolling within content
                        tocList.querySelectorAll('.toc-link').forEach(link => {
                            link.addEventListener('click', (e) => {
                                e.preventDefault();
                                const selector = link.getAttribute('data-target') || '';
                                const id = selector.startsWith('#') ? selector.slice(1) : selector;
                                const target = document.getElementById(id);
                                if (target) {
                                    const header = document.querySelector('.header');
                                    const headerH = header ? header.offsetHeight : 0;
                                    const y = window.scrollY + target.getBoundingClientRect().top - headerH - 10;
                                    window.scrollTo({ top: y, behavior: 'smooth' });
                                    try { history.replaceState(null, '', `#${id}`); } catch (_) {}
                                }
                            });
                        });
                    } catch (err) {
                        tocList.innerHTML = '<li class="toc-item" style="color:#dc3545;">Failed to build table of contents</li>';
                        // Optionally log error
                        console.warn('TOC build error', err);
                    }
                })();

                // If URL already has a hash, scroll to it with offset once content is ready
                if (location.hash) {
                    const id = location.hash.slice(1);
                    const target = document.getElementById(id);
                    if (target) {
                        const header = document.querySelector('.header');
                        const headerH = header ? header.offsetHeight : 0;
                        const y = window.scrollY + target.getBoundingClientRect().top - headerH - 10;
                        window.scrollTo({ top: y });
                    }
                }

            } catch (error) {
                contentLoading.innerHTML = `
                    <div style="text-align: center; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>Error Loading Document</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Load document when page loads
        loadDocument();
    </script>
</body>
</html> 