<!DOCTYPE html>
<html lang="en">
    <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Documenta â€” Editor</title>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
        <script src="https://unpkg.com/@jsplumb/browser-ui@6.3.9/dist/js/jsplumb-browser-ui.umd.min.js"></script>
        <script src="https://unpkg.com/gojs/release/go.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
        }

        .header {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px 30px;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1400px;
            margin: 0 auto;
        }

        .logo {
            font-size: 1.5rem;
            color: #667eea;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn.secondary {
            background: #6c757d;
        }

        .btn.secondary:hover {
            box-shadow: 0 5px 15px rgba(108, 117, 125, 0.3);
        }

        .btn.success {
            background: #28a745;
        }

        .btn.success:hover {
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
        }

        .main-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
        }

        .toolbar {
            background: white;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 12px 16px;
            border-bottom: 1px solid #e9ecef;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            gap: 12px;
            position: sticky;
            top: 72px; /* stick below the header */
            z-index: 950; /* below header (1000), above content */
        }

        @media (max-width: 1024px) {
            .toolbar { top: 100px; }
        }

        .toolbar-group {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding-right: 12px;
            border-right: 1px solid #eef0f3;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .toolbar-group:last-of-type { border-right: none; padding-right: 0; }

        .toolbar-btn {
            background: white;
            border: 1px solid #e9ecef;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .toolbar-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .toolbar-btn[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Flowchart detect overlay */
        .image-wrapper { position: relative; display: inline-block; }
        .flowchart-suggest {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(102, 126, 234, 0.95);
            color: #fff;
            padding: 6px 10px;
            border-radius: 16px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            cursor: pointer;
        }
        .flowchart-suggest i { font-size: 12px; }

        .toolbar-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .toolbar-separator { display: none; }

        .dropdown {
            position: relative;
            display: inline-block;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: 160px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1001;
            border-radius: 8px;
            border: 1px solid #e9ecef;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .dropdown:hover .dropdown-content {
            display: block;
        }

        .dropdown-item {
            color: #333;
            padding: 12px 16px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: background-color 0.3s;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .editor-container {
            background: white;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            min-height: 600px;
            position: relative;
        }

        .editor {
            padding: 30px;
            min-height: 600px;
            outline: none;
            line-height: 1.6;
            color: #2c3e50;
        }
        .editor p { min-height: 1em; }

        /* Marquee selection and multi-select styles */
        .multi-selected {
            outline: 2px dashed #28a745;
            outline-offset: 2px;
        }
        .selection-rect {
            position: absolute;
            border: 2px solid rgba(102,126,234,0.9);
            background: rgba(102,126,234,0.15);
            pointer-events: none;
            z-index: 2000;
        }
        .context-menu {
            position: fixed;
            background: #fff;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
            min-width: 180px;
            padding: 6px 0;
            z-index: 10000;
            display: none;
        }
        .context-menu button {
            width: 100%;
            background: transparent;
            border: none;
            text-align: left;
            padding: 10px 14px;
            cursor: pointer;
            font-size: 14px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .context-menu button:hover { background: #f8f9fa; }
        /* Image wrapper with visible border and controls */
        .img-wrap {
            display: inline-block;
            position: relative;
            max-width: 100%;
            border: 2px solid #cfd6e4; /* definite border */
            border-radius: 8px;
            padding: 6px;
            margin: 10px 0;
            background: #fff;
        }
        .img-delete {
            position: absolute;
            top: -10px;
            right: -10px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #dc3545;
            color: #fff;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 2;
        }
        .img-delete:hover { background: #c82333; }

        /* Prevent button text from being editable */
        .editor button,
        .editor .flowchart-toolbar-btn,
        .editor .toolbar-btn,
        .editor .toolbar,
        .editor .toolbar-group,
        .editor .dropdown,
        .editor .dropdown-content,
        .editor .dropdown-item,
        .editor .flowchart-toolbar,
        .editor .flowchart-toolbar-group {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        /* Prevent contenteditable from affecting toolbar elements */
        /* Prevent contenteditable on toolbar elements (attribute handled in HTML/JS) */

        .editor:focus {
            outline: none;
        }

        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #6c757d;
        }

        .status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
        }

        .status.show {
            transform: translateX(0);
        }

        .status.success {
            background: #28a745;
        }

        .status.error {
            background: #dc3545;
        }

        .status.info {
            background: #17a2b8;
        }

        /* Flowchart Work Area styles */
        .flowchart-work-area {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            display: flex;
            flex-direction: column;
        }

        .flowchart-work-area-header {
            background: white;
            padding: 15px 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .flowchart-work-area-header h3 {
            margin: 0;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flowchart-work-area .flowchart-container {
            flex: 1;
            margin: 0;
            border: none;
            border-radius: 0;
            background: #f8f9fa;
            position: relative;
            overflow: hidden;
        }

        .flowchart-canvas {
            position: absolute;
            top: 60px;
            left: 0;
            right: 0;
            bottom: 0;
            background: #f8f9fa;
            overflow: auto;
        }

        /* Flowchart styles */
        .flowchart-container {
            position: relative;
            min-height: 400px;
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            margin: 20px 0;
            padding: 0;
            background: #f5f5f5;
            resize: vertical;
            overflow: hidden;
        }

        .flowchart-canvas {
            position: relative;
            width: 100%;
            height: calc(100% - 60px);
            background: #f8f9fa;
        }

        .flowchart-toolbar {
            margin: 0;
            border-radius: 8px 8px 0 0;
        }

        .flowchart-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .flowchart-shape {
            position: absolute;
            min-width: 120px;
            min-height: 60px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .flowchart-shape.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }

        .flowchart-shape.rectangle {
            border-radius: 8px;
        }

        .flowchart-shape.diamond {
            transform: rotate(45deg);
            border-radius: 0;
        }

        .flowchart-shape.diamond .shape-content {
            transform: rotate(-45deg);
        }

        .flowchart-shape.circle {
            border-radius: 50%;
            min-width: 100px;
            min-height: 100px;
        }

        .flowchart-shape.parallelogram {
            transform: skew(-20deg);
        }

        .flowchart-shape.parallelogram .shape-content {
            transform: skew(20deg);
        }

        .flowchart-shape.hexagon {
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }

        .shape-content {
            padding: 10px;
            text-align: center;
            font-weight: 500;
            color: #2c3e50;
            word-wrap: break-word;
            overflow: hidden;
        }

        .flowchart-controls {
            position: absolute;
            top: -30px;
            right: 0;
            display: none;
            gap: 5px;
        }

        .flowchart-shape:hover .flowchart-controls {
            display: flex;
        }

        .flowchart-control-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .flowchart-control-btn:hover {
            background: #5a6fd8;
        }

        .flowchart-control-btn.delete {
            background: #dc3545;
        }

        .flowchart-control-btn.delete:hover {
            background: #c82333;
        }

        .flowchart-toolbar {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            display: none;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .flowchart-toolbar.active {
            display: block;
        }
        /* Keep per-block toolbars visible while interacting */
        .gojs-container .flowchart-toolbar,
        .flowchart-container .flowchart-toolbar {
            position: sticky;
            top: 0;
            z-index: 5;
            background: #ffffff;
        }

        .flowchart-toolbar-group {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;
        }

        .flowchart-toolbar-btn {
            background: white;
            border: 1px solid #e9ecef;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            pointer-events: auto;
        }

        .flowchart-toolbar-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .flowchart-toolbar-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }

        .connector-line {
            stroke: #667eea;
            stroke-width: 2;
            fill: none;
        }

        /* Connection nodes styles */
        .connection-node {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.2s ease;
            display: none;
        }

        .connection-node:hover {
            background: #28a745;
            transform: scale(1.2);
        }

        .connection-node.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-node.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }

        .connection-node.left {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .connection-node.right {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }

        .flowchart-shape:hover .connection-node {
            display: block;
        }

        .connection-node.active {
            background: #28a745;
            transform: scale(1.2);
        }

        /* Form controls in toolbar */
        .toolbar select,
        .toolbar input[type="color"] {
            height: 34px;
            padding: 4px 8px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: white;
        }
        .gojs-export-wrapper { position: relative; display: inline-block; }
        .gojs-edit-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(102,126,234,0.95);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .gojs-unlock-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(40,167,69,0.95);
            color: #fff;
            border: none;
            border-radius: 14px;
            padding: 6px 10px;
            font-size: 12px;
            cursor: pointer;
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
            z-index: 5;
        }
        /* Diagram (draw.io) modal */
        .diagram-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .diagram-modal {
            background: #fff;
            width: min(1200px, 96vw);
            height: min(800px, 92vh);
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .diagram-modal-header { padding: 10px 12px; border-bottom: 1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between; }
        .diagram-modal-title { font-weight: 600; color: #2c3e50; }
        .diagram-modal-toolbar { display:flex; gap:8px; }
        .diagram-modal-body { flex:1; }
        .diagram-iframe { width: 100%; height: 100%; border: 0; }

        /* Paste Flowchart Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }
        .modal {
            background: #fff;
            width: min(900px, 96vw);
            max-height: 90vh;
            border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.3);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        .modal-header { padding: 14px 18px; border-bottom: 1px solid #e9ecef; display:flex; align-items:center; justify-content:space-between; }
        .modal-title { font-weight: 600; color: #2c3e50; }
        .modal-body { padding: 16px; overflow: auto; }
        .modal-footer { padding: 12px 16px; border-top: 1px solid #e9ecef; display:flex; align-items:center; justify-content:flex-end; gap:10px; }
        .paste-zone { border: 2px dashed #cfd6e4; border-radius: 10px; padding: 20px; text-align: center; color:#6c757d; background:#f8f9fb; }
        .paste-zone.dragover { border-color:#667eea; background:#f0f4ff; }
        .paste-preview { margin-top: 12px; display:flex; justify-content:center; }
        .paste-preview img { max-width: 100%; max-height: 60vh; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }

        .connector-arrow {
            fill: #667eea;
        }
        /* Connection nodes styles for saved content */
        .connection-node {
            position: absolute;
            width: 12px;
            height: 12px;
            background: #667eea;
            border: 2px solid white;
            border-radius: 50%;
            cursor: pointer;
            z-index: 1001;
            transition: all 0.2s ease;
            display: none;
        }
        .connection-node:hover {
            background: #28a745;
            transform: scale(1.2);
        }
        .connection-node.top {
            top: -6px;
            left: 50%;
            transform: translateX(-50%);
        }
        .connection-node.bottom {
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
        }
        .connection-node.left {
            left: -6px;
            top: 50%;
            transform: translateY(-50%);
        }
        .connection-node.right {
            right: -6px;
            top: 50%;
            transform: translateY(-50%);
        }
        .flowchart-shape:hover .connection-node {
            display: block;
        }
        .connection-node.active {
            background: #28a745;
            transform: scale(1.2);
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <div class="logo">
                <i class="fas fa-edit"></i> Documenta Editor
            </div>
            <div class="header-actions">
                <a href="/projects" class="btn secondary">
                    <i class="fas fa-home"></i> Home
                </a>
                <button id="saveBtn" class="btn success">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="toolbar">
            <div class="toolbar-group">
                <button class="toolbar-btn" data-command="bold" title="Bold">
                    <i class="fas fa-bold"></i>
                </button>
                <button class="toolbar-btn" data-command="italic" title="Italic">
                    <i class="fas fa-italic"></i>
                </button>
                <button class="toolbar-btn" data-command="underline" title="Underline">
                    <i class="fas fa-underline"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" data-command="justifyLeft" title="Align Left">
                    <i class="fas fa-align-left"></i>
                </button>
                <button class="toolbar-btn" data-command="justifyCenter" title="Align Center">
                    <i class="fas fa-align-center"></i>
                </button>
                <button class="toolbar-btn" data-command="justifyRight" title="Align Right">
                    <i class="fas fa-align-right"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">
                    <i class="fas fa-list-ul"></i>
                </button>
                <button class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">
                    <i class="fas fa-list-ol"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" data-command="createLink" title="Insert Link">
                    <i class="fas fa-link"></i>
                </button>
                <button class="toolbar-btn" data-command="insertImage" title="Upload Image">
                    <i class="fas fa-image"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" data-command="insertTable" title="Insert Table">
                    <i class="fas fa-table"></i>
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <button class="toolbar-btn" data-command="insertGoJS" title="Insert GoJS Flowchart">
                    <i class="fas fa-project-diagram"></i> GoJS
                </button>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <select id="fontSize" title="Font Size">
                    <option value="1">Small</option>
                    <option value="3" selected>Normal</option>
                    <option value="5">Large</option>
                    <option value="7">Extra Large</option>
                </select>
                <select id="lineSpacing" title="Line Spacing">
                    <option value="1">1.0</option>
                    <option value="1.15" selected>1.15</option>
                    <option value="1.5">1.5</option>
                    <option value="2">2.0</option>
                </select>
                <select id="fontFamily" title="Font Family">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="Courier New">Courier New</option>
                    <option value="Georgia">Georgia</option>
                </select>
            </div>

            <div class="toolbar-separator"></div>

            <div class="toolbar-group">
                <input type="color" id="textColor" title="Text Color" value="#000000">
                <input type="color" id="bgColor" title="Background Color" value="#ffffff">
            </div>
        </div>

        <div class="editor-container">
            <div id="loading" class="loading">
                <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 20px;"></i>
                <h3>Loading Document...</h3>
            </div>
            <div id="editor" class="editor" contenteditable="true" style="display: none; position: relative;" data-contenteditable-toolbar="false"></div>
        </div>
    </div>

    <div id="status" class="status"></div>

    <script>
        // Get unique ID from URL
        const uniqueId = window.location.pathname.split('/').pop();
        // Capture token from query (if present) and provide a fallback retriever
        const urlToken = new URLSearchParams(location.search).get('token');
        let editToken = urlToken || null;
        async function ensureEditToken() {
            if (editToken) return editToken;
            try {
                const res = await fetch(`/api/token/${uniqueId}`);
                const data = await res.json();
                if (data && data.token) editToken = data.token;
            } catch (_) { /* ignore */ }
            return editToken;
        }
        
        // Get DOM elements
        const editor = document.getElementById('editor');
        const loading = document.getElementById('loading');
        const saveBtn = document.getElementById('saveBtn');
        const status = document.getElementById('status');
        
        // Global variables for flowchart functionality
        let selectedShape = null;
        let isConnecting = false;
        let startShape = null;
        let shapeCounter = 0;
        let isInsertingShape = false;

        // Multi-select state
        let isSelectingArea = false;
        let selectionStart = { x: 0, y: 0 };
        let selectionRectEl = null;
        let multiSelected = new Set();
        let contextMenuEl = null;

        // Show status message
        function showStatus(message, type = 'info') {
            status.textContent = message;
            status.className = `status ${type}`;
            status.classList.add('show');
            setTimeout(() => status.classList.remove('show'), 3000);
        }

        // Toolbar functionality
        document.querySelectorAll('.toolbar-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const command = btn.dataset.command;
                
                if (command) {
                    if (command === 'createLink') {
                        const url = prompt('Enter URL:');
                        if (url) {
                            document.execCommand('createLink', false, url);
                        }
                    } else if (command === 'insertImage') {
                        const input = document.createElement('input');
                        input.type = 'file';
                        input.accept = 'image/*';
                        input.onchange = () => {
                            const file = input.files && input.files[0];
                            if (!file) return;
                            const reader = new FileReader();
                            reader.onload = () => {
                                const dataUrl = reader.result;
                                if (typeof dataUrl === 'string') {
                                    // Insert then enhance with resizer/align controls
                                    document.execCommand('insertImage', false, dataUrl);
                                    enhanceImagesForEditing();
                                }
                            };
                            reader.readAsDataURL(file);
                        };
                        input.click();
                    } else if (command === 'convertToFlowchart') {
                        convertSelectedImageToFlowchart();
                    } else if (command === 'detectFlowcharts') {
                        detectFlowchartImages();
                    } else if (command === 'insertTable') {
                        const rows = prompt('Enter number of rows:', '3');
                        const cols = prompt('Enter number of columns:', '3');
                        if (rows && cols) {
                            insertTable(parseInt(rows), parseInt(cols));
                        }
                    } else {
                        document.execCommand(command, false, null);
                    }
                    
                    btn.classList.toggle('active');
                    setTimeout(() => btn.classList.remove('active'), 200);
                }
            });
        });

        // GoJS insert button (main toolbar)
        document.querySelectorAll('[data-command="insertGoJS"]').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                insertGoJSFlowchart();
            });
        });

        // Font controls

        // Removed: convertSelectedImageToFlowchart

        // Heuristic detection: scan images and suggest conversion for likely flowcharts
        // Removed: detectFlowchartImages

        // Image enhancement: resizable and alignment controls
        function enhanceImagesForEditing() {
            const imgs = Array.from(editor.querySelectorAll('img'));
            imgs.forEach(img => {
                // Skip GoJS export images (they are wrapped)
                if (img.closest('.gojs-export-wrapper')) return;
                // Wrap image
                let wrap = img.closest('.img-wrap');
                if (!wrap) {
                    wrap = document.createElement('span');
                    wrap.className = 'img-wrap';
                    wrap.style.display = 'inline-block';
                    wrap.style.position = 'relative';
                    wrap.style.maxWidth = '100%';
                    img.parentNode.insertBefore(wrap, img);
                    wrap.appendChild(img);
                }
                img.style.display = 'block';
                img.style.maxWidth = '100%';
                img.style.height = 'auto';

                // Add delete button if missing
                if (!wrap.querySelector('.img-delete')) {
                    const del = document.createElement('button');
                    del.className = 'img-delete';
                    del.type = 'button';
                    del.innerHTML = '<i class="fas fa-trash"></i>';
                    del.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        const container = del.closest('.img-wrap');
                        if (container) {
                            container.remove();
                            showStatus('Image removed', 'success');
                        }
                    });
                    wrap.appendChild(del);
                }
                // Add resizer handle if missing
                if (!wrap.querySelector('.img-resize')) {
                    const handle = document.createElement('span');
                    handle.className = 'img-resize';
                    Object.assign(handle.style, {
                        position: 'absolute', right: '-6px', bottom: '-6px', width: '12px', height: '12px',
                        background: '#667eea', borderRadius: '50%', cursor: 'nwse-resize', boxShadow: '0 1px 3px rgba(0,0,0,0.2)'
                    });
                    wrap.appendChild(handle);
                    let startX = 0, startW = 0;
                    const onMove = (e) => {
                        const dx = e.clientX - startX;
                        const newW = Math.max(40, startW + dx);
                        img.style.width = newW + 'px';
                    };
                    const onUp = () => {
                        document.removeEventListener('mousemove', onMove);
                        document.removeEventListener('mouseup', onUp);
                    };
                    handle.addEventListener('mousedown', (e) => {
                        e.preventDefault(); e.stopPropagation();
                        startX = e.clientX; startW = img.getBoundingClientRect().width;
                        document.addEventListener('mousemove', onMove);
                        document.addEventListener('mouseup', onUp);
                    });
                }
                // Add alignment toolbar if missing
                if (!wrap.querySelector('.img-toolbar')) {
                    const bar = document.createElement('div');
                    bar.className = 'img-toolbar';
                    Object.assign(bar.style, {
                        position: 'absolute', left: '50%', transform: 'translateX(-50%)', top: '-32px',
                        background: '#fff', border: '1px solid #e9ecef', borderRadius: '6px',
                        boxShadow: '0 2px 8px rgba(0,0,0,0.08)', display: 'flex', gap: '6px', padding: '4px 6px'
                    });
                    const mkBtn = (title, icon, cb) => {
                        const b = document.createElement('button'); b.type = 'button'; b.title = title;
                        b.innerHTML = `<i class="fas ${icon}"></i>`;
                        Object.assign(b.style, { background:'#fff', border:'1px solid #e9ecef', borderRadius:'4px', padding:'4px 6px', cursor:'pointer' });
                        b.addEventListener('click', (e)=>{ e.preventDefault(); e.stopPropagation(); cb(); });
                        return b;
                    };
                    const alignWrap = () => { wrap.style.display = 'block'; wrap.style.textAlign = 'center'; img.style.margin = '0 auto'; };
                    const alignLeft = () => { wrap.style.display = 'block'; wrap.style.textAlign = 'left'; img.style.margin = '0'; };
                    const alignRight = () => { wrap.style.display = 'block'; wrap.style.textAlign = 'right'; img.style.margin = '0'; };
                    bar.appendChild(mkBtn('Align Left','fa-align-left', alignLeft));
                    bar.appendChild(mkBtn('Center','fa-align-center', alignWrap));
                    bar.appendChild(mkBtn('Align Right','fa-align-right', alignRight));
                    wrap.appendChild(bar);
                    // Show toolbar on hover
                    wrap.addEventListener('mouseenter', ()=>{ bar.style.display='flex'; });
                    wrap.addEventListener('mouseleave', ()=>{ bar.style.display='none'; });
                    bar.style.display = 'none';
                }
            });
        }

        // Enhance any existing images after content load
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(enhanceImagesForEditing, 0);
            ensureContextMenu();
        });

        // Insert pasted image with wrapper and border
        function insertPastedImage(dataUrl) {
            const html = `
                <span class="img-wrap">
                    <img src="${dataUrl}" alt="Pasted image" style="max-width:100%; height:auto; display:block;" />
                    <button class="img-delete" type="button"><i class="fas fa-trash"></i></button>
                </span>`;
            insertHtmlIntoEditor(html);
            requestAnimationFrame(() => { enhanceImagesForEditing(); });
        }

        // Handle paste events to detect images
        editor.addEventListener('paste', (e) => {
            const items = e.clipboardData && e.clipboardData.items;
            if (items && items.length) {
                for (const item of items) {
                    if (item.type && item.type.indexOf('image') !== -1) {
                        const file = item.getAsFile();
                        if (file) {
                            e.preventDefault();
                            const reader = new FileReader();
                            reader.onload = () => {
                                const dataUrl = reader.result;
                                if (typeof dataUrl === 'string') insertPastedImage(dataUrl);
                            };
                            reader.readAsDataURL(file);
                            return; // handle one image per paste
                        }
                    }
                }
            }
            // For non-image paste, allow default then enhance after a tick
            setTimeout(enhanceImagesForEditing, 0);
        });

        function markFlowchartCandidate(img) {
            // Wrap image if not already wrapped
            if (!img.parentElement.classList.contains('image-wrapper')) {
                const wrapper = document.createElement('span');
                wrapper.className = 'image-wrapper';
                img.parentElement.insertBefore(wrapper, img);
                wrapper.appendChild(img);
            }
            const wrapperEl = img.parentElement;
            // Avoid duplicate badge
            if (wrapperEl.querySelector('.flowchart-suggest')) return;
            const badge = document.createElement('div');
            badge.className = 'flowchart-suggest';
            badge.innerHTML = '<i class="fas fa-project-diagram"></i> Convert to Flowchart';
            badge.addEventListener('click', (e) => {
                e.stopPropagation();
                showStatus('Image-to-flowchart conversion removed. Use GoJS button instead.', 'info');
            });
            wrapperEl.appendChild(badge);
        }

        // Simple edge-density + white-background heuristic
        function isLikelyFlowchart(imgEl) {
            return new Promise((resolve) => {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                img.onload = () => {
                    try {
                        const maxW = 256;
                        const scale = img.width > maxW ? maxW / img.width : 1;
                        const w = Math.max(32, Math.floor(img.width * scale));
                        const h = Math.max(32, Math.floor(img.height * scale));
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        canvas.width = w; canvas.height = h;
                        ctx.drawImage(img, 0, 0, w, h);
                        const { data } = ctx.getImageData(0, 0, w, h);

                        let edges = 0, pixels = w * h, whites = 0;
                        const tEdge = 40; // gradient threshold
                        for (let y = 0; y < h - 1; y++) {
                            for (let x = 0; x < w - 1; x++) {
                                const i = (y * w + x) * 4;
                                const r = data[i], g = data[i+1], b = data[i+2];
                                const gray = (r*0.299 + g*0.587 + b*0.114);
                                const j = (y * w + (x+1)) * 4;
                                const r2 = data[j], g2 = data[j+1], b2 = data[j+2];
                                const grayX = (r2*0.299 + g2*0.587 + b2*0.114);
                                const k = ((y+1) * w + x) * 4;
                                const r3 = data[k], g3 = data[k+1], b3 = data[k+2];
                                const grayY = (r3*0.299 + g3*0.587 + b3*0.114);
                                const dx = Math.abs(gray - grayX);
                                const dy = Math.abs(gray - grayY);
                                if (dx + dy > tEdge) edges++;
                                if (gray > 235) whites++;
                            }
                        }
                        const edgeDensity = edges / pixels;
                        const whiteRatio = whites / pixels;
                        // Flowcharts: lots of edges but large white background
                        const likely = (edgeDensity > 0.10 && whiteRatio > 0.40) || (edgeDensity > 0.18);
                        resolve(likely);
                    } catch (e) {
                        resolve(false);
                    }
                };
                img.onerror = () => resolve(false);
                // Use current src; if cross-origin blocks pixel access, onload still fires but getImageData will throw
                img.src = imgEl.src;
            });
        }
        document.getElementById('fontSize').addEventListener('change', (e) => {
            document.execCommand('fontSize', false, e.target.value);
        });

        document.getElementById('fontFamily').addEventListener('change', (e) => {
            document.execCommand('fontName', false, e.target.value);
        });

        // Line spacing: wrap selection's parent block(s) and set line-height
        function applyLineSpacing(multiplier) {
            const sel = window.getSelection();
            if (!sel || sel.rangeCount === 0) return;
            const range = sel.getRangeAt(0);
            // Find nearest block element within editor
            let node = range.commonAncestorContainer;
            if (node.nodeType === 3) node = node.parentNode;
            // If selection spans multiple blocks, apply to each block-level element inside range
            const blocks = new Set();
            const walker = document.createTreeWalker(editor, NodeFilter.SHOW_ELEMENT | NodeFilter.SHOW_TEXT, null);
            while (walker.nextNode()) {
                const n = walker.currentNode;
                if (!range.intersectsNode(n)) continue;
                const el = n.nodeType === 3 ? n.parentElement : n;
                if (!el) continue;
                // consider p, div, li, h1..h6 as blocks
                const isBlock = /^(P|DIV|LI|H[1-6])$/.test(el.tagName);
                if (isBlock) blocks.add(el);
            }
            if (blocks.size === 0) {
                // fallback: apply to the nearest paragraph
                let p = node;
                while (p && p !== editor && !/^(P|DIV|LI|H[1-6])$/.test(p.tagName)) p = p.parentElement;
                if (p && p !== editor) blocks.add(p);
            }
            blocks.forEach(b => { b.style.lineHeight = multiplier; });
        }

        document.getElementById('lineSpacing').addEventListener('change', (e) => {
            applyLineSpacing(e.target.value);
        });

        document.getElementById('textColor').addEventListener('change', (e) => {
            document.execCommand('foreColor', false, e.target.value);
        });

        document.getElementById('bgColor').addEventListener('change', (e) => {
            document.execCommand('hiliteColor', false, e.target.value);
        });

        // Insert table function
        function insertTable(rows, cols) {
            let tableHTML = '<table border="1" style="border-collapse: collapse; width: 100%;">';
            for (let i = 0; i < rows; i++) {
                tableHTML += '<tr>';
                for (let j = 0; j < cols; j++) {
                    tableHTML += '<td style="padding: 8px; border: 1px solid #ddd;">Cell</td>';
                }
                tableHTML += '</tr>';
            }
            tableHTML += '</table>';
            document.execCommand('insertHTML', false, tableHTML);
        }

        // Flowchart functions
        function insertFlowchart() {
            const fid = `flowchart-${Date.now()}`;
            const flowchartHTML = `
                <div class="flowchart-container" id="${fid}" contenteditable="false">
                    <div class="flowchart-toolbar" id="flowchart-toolbar">
                        <div class="flowchart-toolbar-group">
                            <button class="flowchart-toolbar-btn" data-action="connect">
                                <i class="fas fa-link"></i> Connect
                            </button>
                            <button class="flowchart-toolbar-btn" data-action="disconnect">
                                <i class="fas fa-unlink"></i> Disconnect
                            </button>
                            <button class="flowchart-toolbar-btn" data-action="clear">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                        </div>
                        <div class="flowchart-toolbar-group">
                            <button class="flowchart-toolbar-btn" data-action="add-rectangle">
                                <i class="fas fa-square"></i> Rectangle
                            </button>
                            <button class="flowchart-toolbar-btn" data-action="add-diamond">
                                <i class="fas fa-gem"></i> Diamond
                            </button>
                            <button class="flowchart-toolbar-btn" data-action="add-circle">
                                <i class="fas fa-circle"></i> Circle
                            </button>
                        </div>
                        <div class="flowchart-toolbar-group">
                            <button class="flowchart-toolbar-btn" data-action="increase-height" title="Increase height">
                                <i class="fas fa-up-down"></i> Taller
                            </button>
                            <button class="flowchart-toolbar-btn" data-action="decrease-height" title="Decrease height">
                                <i class="fas fa-compress-alt"></i> Shorter
                            </button>
                            <button class="flowchart-toolbar-btn" data-action="increase-width" title="Increase width">
                                <i class="fas fa-arrows-left-right"></i> Wider
                            </button>
                            <button class="flowchart-toolbar-btn" data-action="decrease-width" title="Decrease width">
                                <i class="fas fa-compress"></i> Narrower
                            </button>
                        </div>
                    </div>
                    <div class="flowchart-canvas">
                        <svg class="flowchart-svg" width="100%" height="100%" style="position: absolute; top: 0; left: 0; pointer-events: none;">
                            <defs></defs>
                        </svg>
                        <div class="flowchart-hint" style="padding: 20px; text-align: center; color: #6c757d;">
                            <i class="fas fa-plus" style="font-size: 2rem; margin-bottom: 10px;"></i>
                            <p>Click toolbar buttons to add shapes or use connection nodes to connect them</p>
                        </div>
                    </div>
                </div>
            `;
            document.execCommand('insertHTML', false, flowchartHTML);
            const container = document.getElementById(fid);
            if (container) initializeFlowchart();
        }

        function exitFlowchartWorkArea() {
            const workArea = document.querySelector('.flowchart-work-area');
            if (workArea) {
                workArea.remove();
            }
        }

        function insertShape(shapeType) {
            if (isInsertingShape) return; // Prevent duplicate insertions
            
            isInsertingShape = true;
            const shapeId = `shape-${++shapeCounter}`;
            const shapeHTML = `
                <div class="flowchart-shape ${shapeType}" id="${shapeId}" style="left: 50px; top: 50px;">
                    <div class="shape-content" contenteditable="true">${shapeType.charAt(0).toUpperCase() + shapeType.slice(1)}</div>
                    <div class="flowchart-controls">
                        <button class="flowchart-control-btn" data-action="edit" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="flowchart-control-btn delete" data-action="delete" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="connection-node top" data-position="top"></div>
                    <div class="connection-node bottom" data-position="bottom"></div>
                    <div class="connection-node left" data-position="left"></div>
                    <div class="connection-node right" data-position="right"></div>
                </div>
            `;
            
            document.execCommand('insertHTML', false, shapeHTML);
            initializeShape(document.getElementById(shapeId));
            
            // Reset flag after a short delay
            setTimeout(() => {
                isInsertingShape = false;
            }, 100);
        }

        function initializeFlowchart() {
            const flowchart = document.querySelector('.flowchart-container');
            if (!flowchart) return;
            initializeFlowchartFor(flowchart);
        }
            
        function initializeFlowchartFor(flowchart) {
            if (!flowchart) return;
            // Ensure shapes appear inside the canvas (no deprecated DOMNodeInserted)
            const canvas = flowchart.querySelector('.flowchart-canvas');
            if (canvas) {
                const relocateObserver = new MutationObserver((mutations) => {
                    mutations.forEach(m => m.addedNodes.forEach(n => {
                        if (n.nodeType === 1 && n.classList.contains('flowchart-shape') && n.parentElement !== canvas) {
                            canvas.appendChild(n);
                        }
                    }));
                });
                relocateObserver.observe(flowchart, { childList: true });
            }

            const toolbar = flowchart.querySelector('.flowchart-toolbar');
            if (toolbar) toolbar.classList.add('active');

            // Toolbar button events
            if (toolbar) {
            toolbar.querySelectorAll('.flowchart-toolbar-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.preventDefault();
                    const action = btn.dataset.action;
                    if (action === 'connect') {
                        showStatus('Drag from a node dot to another to connect', 'info');
                    } else if (action === 'disconnect') {
                        if (flowchart._jsp) flowchart._jsp.deleteEveryConnection();
                    } else if (action === 'clear') {
                        if (flowchart._jsp) flowchart._jsp.deleteEveryConnection();
                        flowchart.querySelectorAll('.flowchart-shape').forEach(n => n.remove());
                    } else if (action === 'increase-height') {
                        const c = flowchart;
                        const h = Math.max(200, c.offsetHeight + 100);
                        c.style.minHeight = h + 'px';
                    } else if (action === 'decrease-height') {
                        const c = flowchart;
                        const h = Math.max(200, c.offsetHeight - 100);
                        c.style.minHeight = h + 'px';
                    } else if (action === 'increase-width') {
                        const c = flowchart;
                        const w = Math.max(300, c.offsetWidth + 100);
                        c.style.width = w + 'px';
                    } else if (action === 'decrease-width') {
                        const c = flowchart;
                        const w = Math.max(300, c.offsetWidth - 100);
                        c.style.width = w + 'px';
                    } else if (action.startsWith('add-')) {
                        const shapeType = action.replace('add-', '');
                        addShapeToFlowchart(flowchart, shapeType);
                    }
                });
            });
            }

            // Initialize jsPlumb for robust node connections
            if (window.jsPlumbBrowserUI && !flowchart._jsp) {
                const jsp = jsPlumbBrowserUI.newInstance({
                    container: flowchart.querySelector('.flowchart-canvas') || flowchart,
                    connector: { type: 'Bezier', options: { curviness: 80 } },
                    paintStyle: { stroke: '#667eea', strokeWidth: 2 },
                    hoverPaintStyle: { stroke: '#28a745', strokeWidth: 2 },
                    endpoints: { type: 'Dot', options: { radius: 4 } },
                    endpointStyle: { fill: '#667eea' },
                    allowLoopback: false
                });
                flowchart._jsp = jsp;

                const register = (el) => {
                    jsp.manage(el);
                    jsp.draggable(el);
                    jsp.makeSource(el, { filter: '.connection-node', anchor: ['Top','Bottom','Left','Right'], allowLoopback: false });
                    jsp.makeTarget(el, { anchor: ['Top','Bottom','Left','Right'], allowLoopback: false });
                };

                flowchart.querySelectorAll('.flowchart-shape').forEach(register);

                const observer = new MutationObserver((mutations) => {
                    mutations.forEach(m => m.addedNodes.forEach(n => {
                        if (n.nodeType === 1 && n.classList.contains('flowchart-shape')) register(n);
                    }));
                });
                observer.observe(flowchart.querySelector('.flowchart-canvas') || flowchart, { childList: true });
            }
        }

        function initializeShape(shape) {
            if (!shape) return;

            // Make shape draggable
            let isDragging = false;
            let startX, startY, startLeft, startTop;
            let isDrawingTemp = false;
            let tempPath = null;

            shape.addEventListener('mousedown', (e) => {
                if (e.target.closest('.flowchart-controls')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                startLeft = parseInt(shape.style.left) || 0;
                startTop = parseInt(shape.style.top) || 0;
                
                shape.style.zIndex = '1000';
                e.preventDefault();
            });

            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const deltaX = e.clientX - startX;
                const deltaY = e.clientY - startY;
                
                shape.style.left = (startLeft + deltaX) + 'px';
                shape.style.top = (startTop + deltaY) + 'px';
            });

            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    shape.style.zIndex = 'auto';
                    updateConnectors();
                }
            });

            // Shape selection
            shape.addEventListener('click', (e) => {
                if (e.target.closest('.flowchart-controls')) return;
                
                if (isConnecting) {
                    if (startShape && startShape !== shape) {
                        connectShapes(startShape, shape);
                        isConnecting = false;
                        startShape = null;
                        document.body.style.cursor = 'default';
                    }
                } else {
                    selectShape(shape);
                }
            });

            // Control button events
            shape.querySelectorAll('.flowchart-control-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const action = btn.dataset.action;
                    
                    if (action === 'edit') {
                        editShape(shape);
                    } else if (action === 'delete') {
                        deleteShape(shape);
                    }
                });
            });

            // Connection node events: let jsPlumb handle drag-to-connect; keep cursor hints only
            shape.querySelectorAll('.connection-node').forEach(node => {
                node.addEventListener('mousedown', (e) => {
                    e.stopPropagation();
                    document.body.style.cursor = 'crosshair';
                });
                node.addEventListener('mouseup', () => {
                    document.body.style.cursor = 'default';
                });
            });
        }

        function addShapeToFlowchart(flowchart, shapeType) {
            if (isInsertingShape) return; // Prevent duplicate insertions
            
            isInsertingShape = true;
            const shapeId = `shape-${++shapeCounter}`;
            const shapeHTML = `
                <div class="flowchart-shape ${shapeType}" id="${shapeId}" style="left: 50px; top: 50px;">
                    <div class="shape-content" contenteditable="true">${shapeType.charAt(0).toUpperCase() + shapeType.slice(1)}</div>
                    <div class="flowchart-controls">
                        <button class="flowchart-control-btn" data-action="edit" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="flowchart-control-btn delete" data-action="delete" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="connection-node top" data-position="top"></div>
                    <div class="connection-node bottom" data-position="bottom"></div>
                    <div class="connection-node left" data-position="left"></div>
                    <div class="connection-node right" data-position="right"></div>
                </div>
            `;
            
            // Check if we're in a work area and add to canvas if available
            const canvas = flowchart.querySelector('.flowchart-canvas');
            if (canvas) {
                canvas.insertAdjacentHTML('beforeend', shapeHTML);
            } else {
                flowchart.insertAdjacentHTML('beforeend', shapeHTML);
            }
            initializeShape(document.getElementById(shapeId));
            
            // Reset flag after a short delay
            setTimeout(() => {
                isInsertingShape = false;
            }, 100);
        }

        function toggleConnectMode(flowchart) {
            isConnecting = !isConnecting;
            const connectBtn = flowchart.querySelector('[data-action="connect"]');
            
            if (isConnecting) {
                connectBtn.classList.add('active');
                document.body.style.cursor = 'crosshair';
                showStatus('Click first shape to start connection, then click second shape', 'success');
            } else {
                connectBtn.classList.remove('active');
                document.body.style.cursor = 'default';
                startShape = null;
            }
        }

        // Deprecated: jsPlumb handles connections
        function connectShapes() { return; }

        // Deprecated: jsPlumb handles node connections
        function connectShapesWithNodes() { return; }

        function clearActiveNodes() {
            document.querySelectorAll('.connection-node.active').forEach(node => {
                node.classList.remove('active');
            });
        }

        function clearConnections(flowchart) {
            if (flowchart._jsp) flowchart._jsp.deleteEveryConnection();
            showStatus('All connections cleared', 'success');
        }

        function clearFlowchart(flowchart) {
            const shapes = flowchart.querySelectorAll('.flowchart-shape');
            const connectors = flowchart.querySelectorAll('.connector-line');
            
            shapes.forEach(shape => shape.remove());
            connectors.forEach(connector => connector.remove());
            
            showStatus('Flowchart cleared', 'success');
        }

        function selectShape(shape) {
            if (selectedShape && selectedShape.classList) {
                selectedShape.classList.remove('selected');
            }
            selectedShape = shape;
            if (shape && shape.classList) {
                shape.classList.add('selected');
            }
        }

        function editShape(shape) {
            const content = shape.querySelector('.shape-content');
            content.focus();
            const range = document.createRange();
            range.selectNodeContents(content);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
        }

        function deleteShape(shape) {
            const flowchart = shape.closest('.flowchart-container');
            if (flowchart && flowchart._jsp) flowchart._jsp.remove(shape);
            else shape.remove();
            showStatus('Shape deleted', 'success');
        }

        function updateConnectors() {
            // jsPlumb auto-updates
        }

        // Load content
        async function loadContent() {
            try {
                const response = await fetch(`/api/content/${uniqueId}`);
                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error);
                }

                // Extract content from the HTML
                const parser = new DOMParser();
                const doc = parser.parseFromString(data.content, 'text/html');
                
                // Extract main content
                const mainContent = doc.querySelector('.main-content');
                if (mainContent) {
                    editor.innerHTML = mainContent.innerHTML;
                } else {
                    editor.innerHTML = data.content;
                }

                // Initialize existing flowcharts
                editor.querySelectorAll('.flowchart-container').forEach(flowchart => {
                    // Initialize flowchart toolbar
                    const toolbar = flowchart.querySelector('.flowchart-toolbar');
                    if (toolbar) {
                        toolbar.classList.add('active');
                        
                        // Toolbar button events
                        toolbar.querySelectorAll('.flowchart-toolbar-btn').forEach(btn => {
                            btn.addEventListener('click', (e) => {
                                e.preventDefault();
                                const action = btn.dataset.action;
                                
                                if (action === 'connect') {
                                    toggleConnectMode(flowchart);
                                } else if (action === 'disconnect') {
                                    clearConnections(flowchart);
                                } else if (action === 'clear') {
                                    clearFlowchart(flowchart);
                                } else if (action.startsWith('add-')) {
                                    const shapeType = action.replace('add-', '');
                                    addShapeToFlowchart(flowchart, shapeType);
                                }
                            });
                        });
                    }
                    
                    // Initialize existing shapes
                    flowchart.querySelectorAll('.flowchart-shape').forEach(shape => {
                        // Add connection nodes if they don't exist
                        if (!shape.querySelector('.connection-node')) {
                            shape.insertAdjacentHTML('beforeend', `
                                <div class="connection-node top" data-position="top"></div>
                                <div class="connection-node bottom" data-position="bottom"></div>
                                <div class="connection-node left" data-position="left"></div>
                                <div class="connection-node right" data-position="right"></div>
                            `);
                        }
                        initializeShape(shape);
                    });
                });

                // Show editor
                loading.style.display = 'none';
                editor.style.display = 'block';

                // Post-process any GoJS artifacts for re-edit/ unlock support
                try { postProcessGoJS(); } catch (e) { /* non-fatal */ }

            } catch (error) {
                loading.innerHTML = `
                    <div style="text-align: center; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 20px;"></i>
                        <h3>Error Loading Document</h3>
                        <p>${error.message}</p>
                    </div>
                `;
            }
        }

        // Save functionality
        saveBtn.addEventListener('click', async () => {
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';

            try {
                // Ensure we have an edit token
                await ensureEditToken();
                // Create the full HTML document
                const htmlContent = `
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edited Document</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        table {
            border-collapse: collapse;
            width: 100%;
            margin: 20px 0;
        }
        table th, table td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: left;
        }
        table th {
            background: #f8f9fa;
            font-weight: 600;
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            margin: 20px 0;
        }
        /* Flowchart styles for saved content */
        .flowchart-container {
            position: relative;
            min-height: 400px;
            border: 2px dashed #e9ecef;
            border-radius: 8px;
            margin: 20px 0;
            padding: 20px;
            background: #fafbfc;
        }
        .flowchart-shape {
            position: absolute;
            min-width: 120px;
            min-height: 60px;
            border: 2px solid #667eea;
            border-radius: 8px;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: move;
            user-select: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .flowchart-shape.selected {
            border-color: #28a745;
            box-shadow: 0 0 0 3px rgba(40, 167, 69, 0.3);
        }
        .flowchart-shape.rectangle {
            border-radius: 8px;
        }
        .flowchart-shape.diamond {
            transform: rotate(45deg);
            border-radius: 0;
        }
        .flowchart-shape.diamond .shape-content {
            transform: rotate(-45deg);
        }
        .flowchart-shape.circle {
            border-radius: 50%;
            min-width: 100px;
            min-height: 100px;
        }
        .flowchart-shape.parallelogram {
            transform: skew(-20deg);
        }
        .flowchart-shape.parallelogram .shape-content {
            transform: skew(20deg);
        }
        .flowchart-shape.hexagon {
            clip-path: polygon(25% 0%, 75% 0%, 100% 50%, 75% 100%, 25% 100%, 0% 50%);
        }
        .shape-content {
            padding: 10px;
            text-align: center;
            font-weight: 500;
            color: #2c3e50;
            word-wrap: break-word;
            overflow: hidden;
        }
        .flowchart-controls {
            position: absolute;
            top: -30px;
            right: 0;
            display: none;
            gap: 5px;
        }
        .flowchart-shape:hover .flowchart-controls {
            display: flex;
        }
        .flowchart-control-btn {
            background: #667eea;
            color: white;
            border: none;
            border-radius: 4px;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .flowchart-control-btn:hover {
            background: #5a6fd8;
        }
        .flowchart-control-btn.delete {
            background: #dc3545;
        }
        .flowchart-control-btn.delete:hover {
            background: #c82333;
        }
        .flowchart-toolbar {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 15px;
            display: none;
        }
        .flowchart-toolbar.active {
            display: block;
        }
        .flowchart-toolbar-group {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin-right: 20px;
        }
        .flowchart-toolbar-btn {
            background: white;
            border: 1px solid #e9ecef;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        .flowchart-toolbar-btn:hover {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .flowchart-toolbar-btn.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
        .connector-line {
            stroke: #667eea;
            stroke-width: 2;
            fill: none;
        }
        .connector-arrow {
            fill: #667eea;
        }
    </style>
</head>
<body>
    <div class="main-content">
        ${editor.innerHTML}
    </div>
</body>
</html>`;

                const response = await fetch(`/api/save/${uniqueId}?token=${encodeURIComponent(editToken || '')}` , {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ content: htmlContent })
                });

                const result = await response.json();
                
                if (result.success) {
                    showStatus('Document saved successfully!', 'success');
                } else {
                    throw new Error(result.error || 'Failed to save document');
                }

            } catch (error) {
                showStatus(`Error saving document: ${error.message}`, 'error');
            } finally {
                saveBtn.disabled = false;
                saveBtn.innerHTML = '<i class="fas fa-save"></i> Save';
            }
        });

        // Prevent editing of toolbar elements (but allow form controls like selects and color inputs)
        document.addEventListener('DOMContentLoaded', function() {
            const toolbar = document.querySelector('.toolbar');
            if (toolbar) {
                toolbar.addEventListener('click', function(e) {
                    if (e.target && (e.target.closest('select') || e.target.closest('input[type="color"]'))) return;
                    e.preventDefault();
                    e.stopPropagation();
                });

                toolbar.addEventListener('mousedown', function(e) {
                    if (e.target && (e.target.closest('select') || e.target.closest('input[type="color"]'))) return;
                    e.preventDefault();
                    e.stopPropagation();
                });
            }
            
            // Prevent editing of all toolbar-related elements
            const nonEditableSelectors = [
                '.toolbar',
                '.toolbar-group',
                '.toolbar-btn',
                '.dropdown',
                '.dropdown-content',
                '.dropdown-item',
                '.flowchart-toolbar',
                '.flowchart-toolbar-group',
                '.flowchart-toolbar-btn'
            ];
            
            nonEditableSelectors.forEach(selector => {
                document.querySelectorAll(selector).forEach(element => {
                    element.addEventListener('mousedown', function(e) {
                        if (e.target && (e.target.closest('select') || e.target.closest('input[type="color"]'))) return;
                        e.preventDefault();
                        e.stopPropagation();
                    });

                    element.addEventListener('click', function(e) {
                        if (e.target && (e.target.closest('select') || e.target.closest('input[type="color"]'))) return;
                        e.preventDefault();
                        e.stopPropagation();
                    });
                });
            });
        });

        // Handle escape key to cancel connections
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isConnecting) {
                isConnecting = false;
                startShape = null;
                document.body.style.cursor = 'default';
                clearActiveNodes();
                showStatus('Connection cancelled', 'info');
            }
        });

        // Load content when page loads
        loadContent();

        // --- Selection marquee and context menu ---
        function ensureContextMenu() {
            if (contextMenuEl) return;
            contextMenuEl = document.createElement('div');
            contextMenuEl.className = 'context-menu';
            contextMenuEl.innerHTML = `
                <button data-action="delete-selected"><i class="fas fa-trash"></i> Delete Selected</button>
                <button data-action="clear-selection"><i class="fas fa-times"></i> Clear Selection</button>
            `;
            document.body.appendChild(contextMenuEl);
            contextMenuEl.addEventListener('click', (e) => {
                const btn = e.target.closest('button');
                if (!btn) return;
                const action = btn.getAttribute('data-action');
                if (action === 'delete-selected') {
                    deleteSelectedNodes();
                } else if (action === 'clear-selection') {
                    clearMultiSelection();
                }
                hideContextMenu();
            });
            document.addEventListener('click', (e) => {
                if (contextMenuEl && contextMenuEl.style.display === 'block') hideContextMenu();
            });
        }

        function showContextMenu(x, y) {
            ensureContextMenu();
            contextMenuEl.style.left = `${x}px`;
            contextMenuEl.style.top = `${y}px`;
            contextMenuEl.style.display = 'block';
        }
        function hideContextMenu() { if (contextMenuEl) contextMenuEl.style.display = 'none'; }

        function beginSelection(x, y) {
            isSelectingArea = true;
            selectionStart = { x, y };
            selectionRectEl = document.createElement('div');
            selectionRectEl.className = 'selection-rect';
            selectionRectEl.style.left = `${x}px`;
            selectionRectEl.style.top = `${y}px`;
            selectionRectEl.style.width = '0px';
            selectionRectEl.style.height = '0px';
            document.body.appendChild(selectionRectEl);
        }

        function updateSelection(x, y) {
            if (!isSelectingArea || !selectionRectEl) return;
            const minX = Math.min(selectionStart.x, x);
            const minY = Math.min(selectionStart.y, y);
            const w = Math.abs(x - selectionStart.x);
            const h = Math.abs(y - selectionStart.y);
            selectionRectEl.style.left = `${minX}px`;
            selectionRectEl.style.top = `${minY}px`;
            selectionRectEl.style.width = `${w}px`;
            selectionRectEl.style.height = `${h}px`;
            markElementsInsideRect(minX, minY, w, h);
        }

        function endSelection() {
            isSelectingArea = false;
            if (selectionRectEl) {
                selectionRectEl.remove();
                selectionRectEl = null;
            }
        }

        function elementRect(el) {
            const r = el.getBoundingClientRect();
            return { left: r.left + window.scrollX, top: r.top + window.scrollY, right: r.right + window.scrollX, bottom: r.bottom + window.scrollY };
        }

        function rectsIntersect(a, b) {
            return !(b.left > a.right || b.right < a.left || b.top > a.bottom || b.bottom < a.top);
        }

        function markElementsInsideRect(x, y, w, h) {
            const marquee = { left: x, top: y, right: x + w, bottom: y + h };
            // Candidate nodes: images wrappers, flowchart shapes/containers, paragraphs, tables
            const candidates = editor.querySelectorAll('.img-wrap, .flowchart-shape, .flowchart-container, table, p, h1, h2, h3, h4, h5, h6, li');
            multiSelected.forEach(el => el.classList.remove('multi-selected'));
            multiSelected.clear();
            candidates.forEach(el => {
                if (!el.getBoundingClientRect) return;
                const r = elementRect(el);
                if (rectsIntersect(marquee, r)) {
                    el.classList.add('multi-selected');
                    multiSelected.add(el);
                }
            });
        }

        function clearMultiSelection() {
            multiSelected.forEach(el => el.classList.remove('multi-selected'));
            multiSelected.clear();
        }

        function deleteSelectedNodes() {
            if (multiSelected.size === 0) return;
            // Prefer removing higher-level containers to avoid double-removal
            const toRemove = Array.from(multiSelected).sort((a,b) => {
                // deeper nodes later
                const da = depth(a), db = depth(b);
                return da - db;
            });
            const removed = new Set();
            toRemove.forEach(node => {
                if ([...removed].some(r => r.contains(node))) return;
                // If a flowchart shape, remove via jsPlumb if possible
                const flowchart = node.closest && node.closest('.flowchart-container');
                if (node.classList && node.classList.contains('flowchart-shape') && flowchart && flowchart._jsp) {
                    try { flowchart._jsp.remove(node); } catch (_) { node.remove(); }
                } else {
                    node.remove();
                }
                removed.add(node);
            });
            clearMultiSelection();
            showStatus('Selected items deleted', 'success');
        }

        function depth(el) { let d = 0, n = el; while (n) { d++; n = n.parentElement; } return d; }

        // Mouse interactions for marquee selection in editor area
        editor.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return; // left only for marquee
            const isInToolbar = e.target.closest && e.target.closest('.toolbar');
            const isOnControl = e.target.closest && (e.target.closest('.flowchart-toolbar') || e.target.closest('.img-toolbar') || e.target.closest('.img-resize') || e.target.closest('.flowchart-control-btn'));
            if (isInToolbar || isOnControl) return;
            // Start selection when clicking on empty space or outside editable text nodes
            const isInsideEditor = editor.contains(e.target);
            if (!isInsideEditor) return;
            beginSelection(e.pageX, e.pageY);
            clearMultiSelection();
        });
        document.addEventListener('mousemove', (e) => { if (isSelectingArea) updateSelection(e.pageX, e.pageY); });
        document.addEventListener('mouseup', () => { if (isSelectingArea) endSelection(); });

        // Context menu for multi-selected
        editor.addEventListener('contextmenu', (e) => {
            const hasSelection = multiSelected.size > 0;
            if (hasSelection) {
                e.preventDefault();
                showContextMenu(e.clientX, e.clientY);
            }
        });

        // --- Paste Flowchart Modal logic ---
        let pastedImageDataURL = null;
        let pasteModal, pasteZone, pastePreview, closePasteModalBtn, convertPastedBtn, insertPastedBtn;
        let pasteModalInitialized = false;

        function ensurePasteModalRefs() {
            if (pasteModalInitialized) return true;
            pasteModal = document.getElementById('pasteFlowchartModal');
            pasteZone = document.getElementById('pasteZone');
            pastePreview = document.getElementById('pastePreview');
            closePasteModalBtn = document.getElementById('closePasteModalBtn');
            convertPastedBtn = document.getElementById('convertPastedBtn');
            insertPastedBtn = document.getElementById('insertPastedBtn');
            if (!pasteModal || !pasteZone || !pastePreview || !closePasteModalBtn || !convertPastedBtn || !insertPastedBtn) return false;

            // Bind once
            closePasteModalBtn.addEventListener('click', closePasteFlowchartModal);
            pasteModal.addEventListener('click', (e) => { if (e.target === pasteModal) closePasteFlowchartModal(); });

            // Handle paste
            pasteZone.addEventListener('paste', (e) => {
                const items = e.clipboardData && e.clipboardData.items;
                if (!items) return;
                for (const item of items) {
                    if (item.type.indexOf('image') !== -1) {
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (evt) => showPastedPreview(evt.target.result);
                        reader.readAsDataURL(file);
                        e.preventDefault();
                        break;
                    }
                }
            });

            // Handle drag & drop
            pasteZone.addEventListener('dragover', (e) => { e.preventDefault(); pasteZone.classList.add('dragover'); });
            pasteZone.addEventListener('dragleave', () => pasteZone.classList.remove('dragover'));
            pasteZone.addEventListener('drop', (e) => {
                e.preventDefault(); pasteZone.classList.remove('dragover');
                const file = e.dataTransfer.files && e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (evt) => showPastedPreview(evt.target.result);
                    reader.readAsDataURL(file);
                }
            });

            // Convert pasted to flowchart work area (Assisted tracing)
            convertPastedBtn.addEventListener('click', () => {
                if (!pastedImageDataURL) return;
                const fid = `flowchart-${Date.now()}`;
                pastePreview.innerHTML = `
                    <div class="flowchart-container" id="${fid}" contenteditable="false" style="min-height:400px;">
                        <div class="flowchart-toolbar active" id="flowchart-toolbar">
                            <div class="flowchart-toolbar-group">
                                <button class="flowchart-toolbar-btn" data-action="connect"><i class="fas fa-link"></i> Connect</button>
                                <button class="flowchart-toolbar-btn" data-action="disconnect"><i class="fas fa-unlink"></i> Disconnect</button>
                                <button class="flowchart-toolbar-btn" data-action="clear"><i class="fas fa-trash"></i> Clear All</button>
                            </div>
                            <div class="flowchart-toolbar-group">
                                <button class="flowchart-toolbar-btn" data-action="add-rectangle"><i class="fas fa-square"></i> Rectangle</button>
                                <button class="flowchart-toolbar-btn" data-action="add-diamond"><i class="fas fa-gem"></i> Diamond</button>
                                <button class="flowchart-toolbar-btn" data-action="add-circle"><i class="fas fa-circle"></i> Circle</button>
                            </div>
                        </div>
                        <div class="flowchart-canvas" style="background: url('${pastedImageDataURL}') center / contain no-repeat, #f8f9fa; min-height:340px;">
                            <svg class="flowchart-svg" width="100%" height="100%" style="position: absolute; top: 0; left: 0; pointer-events: none;"><defs></defs></svg>
                            <div class="flowchart-hint" style="padding: 20px; text-align: center; color: #6c757d;">
                                <i class="fas fa-plus" style="font-size: 2rem; margin-bottom: 10px;"></i>
                                <p>Trace the chart by adding shapes over the background, then click Done</p>
                            </div>
                        </div>
                    </div>`;
                const container = document.getElementById(fid);
                initializeFlowchartFor(container);
                insertPastedBtn.disabled = false;
            });

            // Insert the traced flowchart into the editor at the caret
            insertPastedBtn.addEventListener('click', () => {
                const fc = pastePreview.querySelector('.flowchart-container');
                if (!fc) return;
                const clone = fc.cloneNode(true);
                const toolbar = clone.querySelector('.flowchart-toolbar');
                if (toolbar) toolbar.classList.add('active');
                document.execCommand('insertHTML', false, clone.outerHTML);
                requestAnimationFrame(() => {
                    const inserted = editor.querySelector(`#${clone.id}`) || editor.querySelector('.flowchart-container:last-of-type');
                    if (inserted) initializeFlowchartFor(inserted);
                });
                closePasteFlowchartModal();
                showStatus('Flowchart inserted into the document', 'success');
            });

            pasteModalInitialized = true;
            return true;
        }

        function openPasteFlowchartModal() {
            if (!ensurePasteModalRefs()) {
                // Try again after a tick in case modal is after script
                setTimeout(() => { ensurePasteModalRefs(); openPasteFlowchartModal(); }, 0);
                return;
            }
            pastedImageDataURL = null;
            pastePreview.style.display = 'none';
            pastePreview.innerHTML = '';
            convertPastedBtn.disabled = true;
            insertPastedBtn.disabled = true;
            pasteModal.style.display = 'flex';
            pasteZone.focus();
        }

        function closePasteFlowchartModal() { if (pasteModal) pasteModal.style.display = 'none'; }

        function showPastedPreview(dataURL) {
            pastedImageDataURL = dataURL;
            pastePreview.style.display = 'flex';
            pastePreview.innerHTML = `<img src="${dataURL}" alt="Pasted flowchart" />`;
            convertPastedBtn.disabled = false;
        }


        // Try to initialize modal refs after DOM fully loaded
        window.addEventListener('load', ensurePasteModalRefs);

        // draw.io embedding removed

        // --- GoJS quick-insert flowchart ---
        function insertGoJSFlowchart() {
            if (!window.go) {
                showStatus('GoJS failed to load. Check your connection.', 'error');
                return;
            }
            const idBase = `gojs-${Date.now()}`;
            const modelJson = {
                nodeDataArray: [
                    { key: 1, text: 'Start' },
                    { key: 2, text: 'Process' },
                    { key: 3, text: 'End' }
                ],
                linkDataArray: [
                    { from: 1, to: 2 },
                    { from: 2, to: 3 }
                ]
            };
            console.log('[GoJS] insertGoJSFlowchart called');
            const html = `
                <div class="flowchart-container gojs-container" id="${idBase}-wrap" contenteditable="false" style="min-height:420px;">
                    <div class="flowchart-toolbar active">
                        <div class="flowchart-toolbar-group">
                            <button class="flowchart-toolbar-btn" data-action="clear"><i class="fas fa-trash"></i> Clear</button>
                            <button class="flowchart-toolbar-btn" data-action="export-png"><i class="fas fa-file-export"></i> Export PNG</button>
                            <button class="flowchart-toolbar-btn" data-action="increase-height" title="Increase height"><i class="fas fa-up-down"></i> Taller</button>
                            <button class="flowchart-toolbar-btn" data-action="decrease-height" title="Decrease height"><i class="fas fa-compress-alt"></i> Shorter</button>
                            <button class="flowchart-toolbar-btn" data-action="done-image" title="Insert as image and finish"><i class="fas fa-image"></i> Done (Image)</button>
                            <button class="flowchart-toolbar-btn" data-action="done-lock" title="Lock and keep vector"><i class="fas fa-lock"></i> Done (Lock)</button>
                        </div>
                    </div>
                    <div class="flowchart-canvas" style="position:relative; min-height:360px; padding:10px; background:#f8f9fa;">
                        <div id="${idBase}" style="width:100%; height:340px; background:white; border:1px solid #e0e0e0; border-radius:6px; overflow:hidden;"></div>
                        <div class="resize-handle" style="position:absolute; right:8px; bottom:8px; width:16px; height:16px; cursor:nwse-resize; background:linear-gradient(135deg,#e0e7ff,#c7d2fe); border:1px solid #adb5bd; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,0.15);"></div>
                    </div>
                    <textarea class="gojs-model" style="display:none;">${JSON.stringify(modelJson)}</textarea>
                </div>`;
            console.log('[GoJS] inserting HTML block');
            insertHtmlIntoEditor(html);
            requestAnimationFrame(() => {
                const container = document.getElementById(`${idBase}-wrap`);
                if (container) {
                    console.log('[GoJS] initializing container', container.id);
                    initializeGoJSInContainer(container);
                } else {
                    console.warn('[GoJS] container not found');
                }
            });
        }

        function insertHtmlIntoEditor(html) {
            // Try execCommand if selection is inside the editor
            const sel = window.getSelection();
            const isInsideEditor = sel && sel.rangeCount > 0 && editor.contains(sel.anchorNode);
            if (isInsideEditor) {
                try {
                    document.execCommand('insertHTML', false, html);
                    ensureTrailingParagraph();
                    placeCaretAtEnd();
                    return;
                } catch (e) { /* fallback below */ }
            }
            // Fallback: append to the end
            editor.focus();
            const temp = document.createElement('div');
            temp.innerHTML = html;
            while (temp.firstChild) {
                editor.appendChild(temp.firstChild);
            }
            ensureTrailingParagraph();
            placeCaretAtEnd();
        }

        function insertImageWithBreak(src) {
            const img = `<img src="${src}" alt="Image" style="max-width:100%; height:auto; border-radius:6px; margin: 10px 0;" />`;
            insertHtmlIntoEditor(img);
        }

        function ensureTrailingParagraph() {
            let last = editor.lastChild;
            // Skip trailing whitespace text nodes
            while (last && last.nodeType === 3 && !last.textContent.trim()) {
                const prev = last.previousSibling; editor.removeChild(last); last = prev;
            }
            if (!last || !(last.nodeName === 'P' && last.innerHTML.trim() === '<br>' || last.textContent.trim() === '')) {
                const p = document.createElement('p');
                p.innerHTML = '<br>';
                editor.appendChild(p);
            }
        }

        function placeCaretAtEnd() {
            const range = document.createRange();
            const sel = window.getSelection();
            const last = editor.lastChild;
            if (!last) return;
            if (last.nodeType === 1) {
                range.setStartAfter(last);
            } else {
                range.setStart(editor, editor.childNodes.length);
            }
            range.collapse(true);
            sel.removeAllRanges();
            sel.addRange(range);
            editor.focus();
        }

        // Ensure images with embedded GoJS model become re-editable
        function postProcessGoJS() {
            // Normalize any legacy Unlock buttons to the current Edit button
            editor.querySelectorAll('.gojs-unlock-btn').forEach(btn => {
                try {
                    btn.classList.remove('gojs-unlock-btn');
                    btn.classList.add('gojs-edit-btn');
                    btn.textContent = 'Edit';
                } catch (_) { /* ignore */ }
            });
            // 1) Wrap any image with data-gojs-model into the expected wrapper and add edit button
            editor.querySelectorAll('img[data-gojs-model]').forEach(img => {
                const modelB64 = img.getAttribute('data-gojs-model');
                let wrapper = img.closest('.gojs-export-wrapper');
                if (!wrapper) {
                    wrapper = document.createElement('span');
                    wrapper.className = 'gojs-export-wrapper';
                    wrapper.setAttribute('data-gojs-model', modelB64);
                    img.parentNode.insertBefore(wrapper, img);
                    wrapper.appendChild(img);
                } else {
                    // keep data in wrapper canonical place
                    wrapper.setAttribute('data-gojs-model', modelB64);
                }
                if (!wrapper.querySelector('.gojs-edit-btn')) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'gojs-edit-btn';
                    btn.textContent = 'Edit';
                    wrapper.appendChild(btn);
                }
                // Clean attribute on img to avoid duplication next loads (optional)
                // img.removeAttribute('data-gojs-model');
            });

            // 2) For static wrappers missing the button, add button
            editor.querySelectorAll('.gojs-export-wrapper').forEach(wrapper => {
                if (!wrapper.querySelector('.gojs-edit-btn')) {
                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'gojs-edit-btn';
                    btn.textContent = 'Edit';
                    wrapper.appendChild(btn);
                }
            });

            // 3) Add Edit button to locked vector GoJS diagrams (no palette + has gojs-container)
            editor.querySelectorAll('.gojs-container').forEach(container => {
                const hasPalette = container.querySelector('[id$="-palette"]');
                const toolbar = container.querySelector('.flowchart-toolbar');
                if (!hasPalette && container.querySelector('div[id^="gojs-"]')) {
                    // locked state; ensure toolbar exists and add Unlock
                    let tb = toolbar;
                    if (!tb) {
                        tb = document.createElement('div');
                        tb.className = 'flowchart-toolbar active';
                        const group = document.createElement('div');
                        group.className = 'flowchart-toolbar-group';
                        tb.appendChild(group);
                        container.insertBefore(tb, container.firstChild);
                    }
                    // Make sure toolbar is visible
                    tb.classList.add('active');
                    const group = tb.querySelector('.flowchart-toolbar-group') || tb;
                    if (!container.querySelector('.gojs-edit-btn')) {
                        const edit = document.createElement('button');
                        edit.type = 'button';
                        edit.className = 'gojs-edit-btn';
                        edit.textContent = 'Edit';
                        container.appendChild(edit);
                    }
                }
            });
        }

        // Re-edit handler for exported images with embedded model
        editor.addEventListener('click', (e) => {
            const btn = e.target.closest && e.target.closest('.gojs-edit-btn');
            if (!btn) return;
            const wrapper = btn.closest('.gojs-export-wrapper');
            if (wrapper) {
                console.log('[GoJS] re-edit from exported image wrapper');
                const b64 = wrapper.getAttribute('data-gojs-model');
                if (!b64) return;
                try {
                    const json = decodeURIComponent(escape(atob(b64)));
                    const model = JSON.parse(json);
                    // Recreate an editable block from the saved model
                    const idBase = `gojs-${Date.now()}`;
                    const html = `
                        <div class="flowchart-container gojs-container" id="${idBase}-wrap" contenteditable="false" style="min-height:420px;">
                            <div class="flowchart-toolbar active">
                                <div class="flowchart-toolbar-group">
                                    <button class="flowchart-toolbar-btn" data-action="clear"><i class="fas fa-trash"></i> Clear</button>
                                    <button class="flowchart-toolbar-btn" data-action="export-png"><i class="fas fa-file-export"></i> Export PNG</button>
                                    <button class="flowchart-toolbar-btn" data-action="increase-height" title="Increase height"><i class="fas fa-up-down"></i> Taller</button>
                                    <button class="flowchart-toolbar-btn" data-action="decrease-height" title="Decrease height"><i class="fas fa-compress-alt"></i> Shorter</button>
                                    <button class="flowchart-toolbar-btn" data-action="done-image" title="Insert as image and finish"><i class="fas fa-image"></i> Done (Image)</button>
                                    <button class="flowchart-toolbar-btn" data-action="done-lock" title="Lock and keep vector"><i class="fas fa-lock"></i> Done (Lock)</button>
                                </div>
                            </div>
                        <div class="flowchart-canvas" style="position:relative; min-height:360px; padding:10px; background:#f8f9fa;">
                            <div id="${idBase}" style="width:100%; height:340px; background:white; border:1px solid #e0e0e0; border-radius:6px; overflow:hidden;"></div>
                                <div class="resize-handle" style="position:absolute; right:8px; bottom:8px; width:16px; height:16px; cursor:nwse-resize; background:linear-gradient(135deg,#e0e7ff,#c7d2fe); border:1px solid #adb5bd; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,0.15);"></div>
                            </div>
                            <textarea class="gojs-model" style="display:none;">${JSON.stringify(model)}</textarea>
                        </div>`;
                    // Replace wrapper with editable block
                    const temp = document.createElement('div');
                    temp.innerHTML = html;
                    const node = temp.firstChild;
                    wrapper.parentNode.insertBefore(node, wrapper);
                    wrapper.remove();
                    console.log('[GoJS] initializing re-edit node from wrapper');
                    initializeGoJSInContainer(node);
                    const tb = node.querySelector('.flowchart-toolbar');
                    if (tb) tb.classList.add('active');
                } catch (err) {
                    showStatus('Failed to re-edit flowchart', 'error');
                }
                return;
            }
            const container = btn.closest('.gojs-container');
            if (container) {
                console.log('[GoJS] re-edit existing locked container');
                try {
                    const diagramDiv = container.querySelector(':scope > .flowchart-canvas > div[id^="gojs-"]:not([id$="-palette"])');
                    const modelEl = container.querySelector(':scope > textarea.gojs-model');
                    let model = { nodeDataArray: [], linkDataArray: [] };
                    try { if (modelEl && (modelEl.value || modelEl.textContent)) model = JSON.parse(modelEl.value || modelEl.textContent); } catch (e) {}
                    // rebuild with palette and toolbar
                    const idBase = diagramDiv && diagramDiv.id ? diagramDiv.id : `gojs-${Date.now()}`;
                    const html = `
                        <div class="flowchart-toolbar active">
                            <div class="flowchart-toolbar-group">
                                <button class="flowchart-toolbar-btn" data-action="clear"><i class="fas fa-trash"></i> Clear</button>
                                <button class="flowchart-toolbar-btn" data-action="export-png"><i class="fas fa-file-export"></i> Export PNG</button>
                                <button class="flowchart-toolbar-btn" data-action="increase-height" title="Increase height"><i class="fas fa-up-down"></i> Taller</button>
                                <button class="flowchart-toolbar-btn" data-action="decrease-height" title="Decrease height"><i class="fas fa-compress-alt"></i> Shorter</button>
                                <button class="flowchart-toolbar-btn" data-action="done-image" title="Insert as image and finish"><i class="fas fa-image"></i> Done (Image)</button>
                                <button class="flowchart-toolbar-btn" data-action="done-lock" title="Lock and keep vector"><i class="fas fa-lock"></i> Done (Lock)</button>
                            </div>
                        </div>
                        <div class="flowchart-canvas" style="position:relative; min-height:360px; padding:10px; background:#f8f9fa;">
                            <div id="${idBase}" style="width:100%; height:340px; background:white; border:1px solid #e0e0e0; border-radius:6px; overflow:hidden;"></div>
                            <div class="resize-handle" style="position:absolute; right:8px; bottom:8px; width:16px; height:16px; cursor:nwse-resize; background:linear-gradient(135deg,#e0e7ff,#c7d2fe); border:1px solid #adb5bd; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,0.15);"></div>
                        </div>`;
                    // Ensure toolbar and palette exist
                    const firstChild = container.firstElementChild;
                    if (!firstChild || !firstChild.classList.contains('flowchart-toolbar')) {
                        const temp = document.createElement('div');
                        temp.innerHTML = html;
                        const toolbar = temp.firstChild;
                        const canvas = temp.lastChild;
                        container.insertBefore(toolbar, container.firstChild);
                        const existingCanvas = container.querySelector(':scope > .flowchart-canvas');
                        if (existingCanvas) existingCanvas.replaceWith(canvas); else container.appendChild(canvas);
                    }
                    // Ensure textarea model exists
                    if (!modelEl) {
                        const ta = document.createElement('textarea');
                        ta.className = 'gojs-model';
                        ta.style.display = 'none';
                        ta.textContent = JSON.stringify(model);
                        container.appendChild(ta);
                    }
                    console.log('[GoJS] initializing existing container');
                    initializeGoJSInContainer(container);
                    const tb2 = container.querySelector('.flowchart-toolbar');
                    if (tb2) tb2.classList.add('active');
                } catch (err) {
                    showStatus('Failed to re-edit flowchart', 'error');
                }
            }
        });

        // Unlock handler for locked GoJS vectors
        editor.addEventListener('click', (e) => {
            const unlock = e.target.closest && e.target.closest('.gojs-unlock-btn');
            if (!unlock) return;
            const container = unlock.closest('.gojs-container');
            if (!container) return;
            try {
                const diagramDiv = container.querySelector(':scope > .flowchart-canvas > div[id^="gojs-"]:not([id$="-palette"])');
                const modelEl = container.querySelector(':scope > textarea.gojs-model');
                let model = { nodeDataArray: [], linkDataArray: [] };
                try { if (modelEl && (modelEl.value || modelEl.textContent)) model = JSON.parse(modelEl.value || modelEl.textContent); } catch (e) {}
                // rebuild with palette and toolbar
                const idBase = diagramDiv && diagramDiv.id ? diagramDiv.id : `gojs-${Date.now()}`;
                const html = `
                    <div class="flowchart-toolbar active">
                        <div class="flowchart-toolbar-group">
                            <button class="flowchart-toolbar-btn" data-action="clear"><i class="fas fa-trash"></i> Clear</button>
                            <button class="flowchart-toolbar-btn" data-action="export-png"><i class="fas fa-file-export"></i> Export PNG</button>
                            <button class="flowchart-toolbar-btn" data-action="increase-height" title="Increase height"><i class="fas fa-up-down"></i> Taller</button>
                            <button class="flowchart-toolbar-btn" data-action="decrease-height" title="Decrease height"><i class="fas fa-compress-alt"></i> Shorter</button>
                            <button class="flowchart-toolbar-btn" data-action="done-image" title="Insert as image and finish"><i class="fas fa-image"></i> Done (Image)</button>
                            <button class="flowchart-toolbar-btn" data-action="done-lock" title="Lock and keep vector"><i class="fas fa-lock"></i> Done (Lock)</button>
                        </div>
                    </div>
                    <div class="flowchart-canvas" style="position:relative; min-height:360px; padding:10px; background:#f8f9fa; display:flex; gap:10px;">
                        <div id="${idBase}-palette" style="width:220px; height:340px; background:white; border:1px solid #e0e0e0; border-radius:6px;"></div>
                        <div id="${idBase}" style="flex:1; height:340px; background:white; border:1px solid #e0e0e0; border-radius:6px; overflow:hidden;"></div>
                        <div class="resize-handle" style="position:absolute; right:8px; bottom:8px; width:16px; height:16px; cursor:nwse-resize; background:linear-gradient(135deg,#e0e7ff,#c7d2fe); border:1px solid #adb5bd; border-radius:3px; box-shadow:0 1px 3px rgba(0,0,0,0.15);"></div>
                    </div>`;
                // Ensure toolbar exists at top
                const firstChild = container.firstElementChild;
                if (!firstChild || !firstChild.classList.contains('flowchart-toolbar')) {
                    const temp = document.createElement('div');
                    temp.innerHTML = html;
                    const toolbar = temp.firstChild;
                    const canvas = temp.lastChild;
                    container.insertBefore(toolbar, container.firstChild);
                    // find existing canvas
                    const existingCanvas = container.querySelector(':scope > .flowchart-canvas');
                    if (existingCanvas) {
                        existingCanvas.replaceWith(canvas);
                    } else {
                        container.appendChild(canvas);
                    }
                }
                // Ensure textarea model exists and has JSON
                if (!modelEl) {
                    const ta = document.createElement('textarea');
                    ta.className = 'gojs-model';
                    ta.style.display = 'none';
                    ta.textContent = JSON.stringify(model);
                    container.appendChild(ta);
                }
                initializeGoJSInContainer(container);
            } catch (err) {
                showStatus('Failed to unlock flowchart', 'error');
            }
        });

        function initializeGoJSInContainer(container) {
            if (!window.go || !container) return;
            const diagramDiv = container.querySelector(':scope > .flowchart-canvas > div[id^="gojs-"]:not([id$="-palette"])');
            // Support both cases: with palette (when unlocking/re-editing) or without (quick insert)
            const paletteDiv = container.querySelector(':scope > .flowchart-canvas > div[id$="-palette"]');
            if (!diagramDiv) return;
            const modelEl = container.querySelector(':scope > textarea.gojs-model');
            let modelData = { nodeDataArray: [], linkDataArray: [] };
            try { if (modelEl && modelEl.value) modelData = JSON.parse(modelEl.value); else if (modelEl && modelEl.textContent) modelData = JSON.parse(modelEl.textContent); } catch (e) {}

            const $ = go.GraphObject.make;
            console.log('[GoJS] initializeGoJSInContainer', { container, diagramDiv });
            const diagram = $(go.Diagram, diagramDiv, {
                'undoManager.isEnabled': true,
                layout: $(go.LayeredDigraphLayout, { direction: 90 })
            });

            // Context menu for nodes
            function makeButton(text, action) {
                return $(
                    'ContextMenuButton',
                    $(go.TextBlock, text),
                    { click: action }
                );
            }
            const nodeMenu = $(go.Adornment, 'Vertical',
                makeButton('Add Node', (e, obj) => {
                    const node = obj.part.adornedPart;
                    const p = node.location.copy(); p.y += 80;
                    diagram.startTransaction('add node');
                    const newdata = { key: diagram.model.nodeDataArray.length + 10, text: 'New Node' };
                    diagram.model.addNodeData(newdata);
                    diagram.commitTransaction('add node');
                }),
                makeButton('Delete', (e, obj) => { diagram.commandHandler.deleteSelection(); })
            );

            // Helper to create small linkable ports on edges
            function makePort(name, spot, output, input) {
                return $(go.Shape, 'Circle', {
                    fill: 'transparent', stroke: null, desiredSize: new go.Size(8, 8),
                    alignment: spot, alignmentFocus: spot, fromSpot: spot, toSpot: spot,
                    fromLinkable: output, toLinkable: input, cursor: 'crosshair'
                }, new go.Binding('portId', '', () => name));
            }

            diagram.nodeTemplate = $(go.Node, 'Spot',
                { contextMenu: nodeMenu, locationSpot: go.Spot.Center },
                // Main panel (drag by this to move)
                $(go.Panel, 'Auto',
                    $(go.Shape, 'RoundedRectangle', { fill: '#e9f0ff', stroke: '#667eea' }),
                    $(go.TextBlock, { margin: 8, editable: true }, new go.Binding('text', 'text').makeTwoWay())
                ),
                // Ports (only edges are linkable)
                makePort('T', go.Spot.Top, true, true),
                makePort('L', go.Spot.Left, true, true),
                makePort('R', go.Spot.Right, true, true),
                makePort('B', go.Spot.Bottom, true, true)
            );
            diagram.linkTemplate = $(go.Link,
                { routing: go.Link.AvoidsNodes, curve: go.Link.JumpOver },
                $(go.Shape),
                $(go.Shape, { toArrow: 'Standard' })
            );

            // Palette with basic shapes
            // palette removed: use duplication of defaults

            // Support ALT+Drag duplication
            diagram.toolManager.draggingTool.isCopyEnabled = true;
            diagram.commandHandler.copySelection = function() {
                const it = diagram.selection.first();
                if (it && it instanceof go.Node) {
                    const d = diagram.model.copyNodeData(it.data);
                    diagram.model.addNodeData(d);
                }
            };
            diagram.addDiagramListener('BackgroundSingleClicked', (e) => diagram.select(null));
            diagram.addDiagramListener('ObjectSingleClicked', (e) => {
                if (e.diagram.lastInput.alt && e.subject && e.subject.part instanceof go.Node) {
                    const n = e.subject.part;
                    diagram.startTransaction('duplicate');
                    const d = diagram.model.copyNodeData(n.data);
                    d.key = undefined;
                    diagram.model.addNodeData(d);
                    const np = diagram.findNodeForData(d);
                    if (np) np.location = new go.Point(n.location.x + 40, n.location.y + 40);
                    diagram.commitTransaction('duplicate');
                }
            });

            // Load model
            diagram.model = new go.GraphLinksModel(modelData.nodeDataArray || [], modelData.linkDataArray || []);

            // Persist model JSON in the DOM for future reloads
            function syncModelToDom() {
                const json = diagram.model.toJson();
                if (modelEl) {
                    if ('value' in modelEl) modelEl.value = json;
                    else modelEl.textContent = json;
                }
            }
            diagram.model.addChangedListener(() => {
                if (diagram.isModified) syncModelToDom();
            });

            // Ensure toolbar is visible initially
            const initialToolbar = container.querySelector('.flowchart-toolbar');
            if (initialToolbar) initialToolbar.classList.add('active');

            // Bind toolbar actions (idempotent)
            function bindGoJSToolbarActions() {
                container.querySelectorAll('.flowchart-toolbar-btn').forEach(btn => {
                    if (btn.getAttribute('data-gojs-bound') === '1') return;
                    btn.setAttribute('data-gojs-bound', '1');
                    btn.addEventListener('click', async () => {
                        const action = btn.dataset.action;
                        console.log('[GoJS] toolbar action', action);
                        if (action === 'clear') {
                            diagram.model = new go.GraphLinksModel([], []);
                            syncModelToDom();
                        } else if (action === 'export-png') {
                            const png = diagram.makeImageData({ background: 'white' });
                            document.execCommand('insertImage', false, png);
                        } else if (action === 'increase-height' || action === 'decrease-height') {
                            const delta = action === 'increase-height' ? 120 : -120;
                            const current = parseInt(diagramDiv.style.height || '340', 10) || 340;
                            const newH = Math.max(240, current + delta);
                            diagramDiv.style.height = newH + 'px';
                            // Expand wrapper min-height too
                            const wrap = container;
                            const wrapMin = parseInt((wrap.style.minHeight || '420').replace('px',''), 10) || 420;
                            wrap.style.minHeight = Math.max(360, wrapMin + delta) + 'px';
                        } else if (action === 'done-image') {
                            // Export and replace the editor block with a static image, but embed model JSON for re-edit
                            const png = diagram.makeImageData({ background: 'white', scale: 2 });
                            const modelJson = diagram.model.toJson();
                            const wrapper = document.createElement('span');
                            wrapper.className = 'gojs-export-wrapper';
                            wrapper.setAttribute('data-gojs-model', btoa(unescape(encodeURIComponent(modelJson))));
                            wrapper.innerHTML = `<img src="${png}" alt="Flowchart" style=\"max-width:100%; height:auto; border-radius:6px; margin: 10px 0;\" />` +
                                                `<button class=\"gojs-edit-btn\" type=\"button\">Edit</button>`;
                            container.parentNode.insertBefore(wrapper, container);
                            container.remove();
                            ensureTrailingParagraph();
                            placeCaretAtEnd();
                        } else if (action === 'done-lock') {
                            // Remove palette and toolbar; keep diagram vector and lock editing
                            const toolbarEl = container.querySelector('.flowchart-toolbar');
                            if (toolbarEl) toolbarEl.remove();
                            if (paletteDiv && paletteDiv.parentNode) paletteDiv.remove();
                            // Stretch diagram to full width
                            diagramDiv.style.width = '100%';
                            // Lock editing
                            diagram.isReadOnly = true;
                            // Add an Edit overlay button to allow re-editing later
                            if (!container.querySelector('.gojs-edit-btn')) {
                                const editBtn = document.createElement('button');
                                editBtn.type = 'button';
                                editBtn.className = 'gojs-edit-btn';
                                editBtn.textContent = 'Edit';
                                container.appendChild(editBtn);
                            }
                            showStatus('Flowchart locked. You can continue editing the document.', 'success');
                        }
                    });
                });
            }
            bindGoJSToolbarActions();

            // Ensure toolbar remains active and re-create if missing
            let toolbar = container.querySelector('.flowchart-toolbar');
            if (!toolbar) {
                toolbar = document.createElement('div');
                toolbar.className = 'flowchart-toolbar active';
                toolbar.innerHTML = `
                    <div class="flowchart-toolbar-group">
                        <button class="flowchart-toolbar-btn" data-action="clear"><i class="fas fa-trash"></i> Clear</button>
                        <button class="flowchart-toolbar-btn" data-action="export-png"><i class="fas fa-file-export"></i> Export PNG</button>
                        <button class="flowchart-toolbar-btn" data-action="increase-height" title="Increase height"><i class="fas fa-up-down"></i> Taller</button>
                        <button class="flowchart-toolbar-btn" data-action="decrease-height" title="Decrease height"><i class="fas fa-compress-alt"></i> Shorter</button>
                        <button class="flowchart-toolbar-btn" data-action="done-image" title="Insert as image and finish"><i class="fas fa-image"></i> Done (Image)</button>
                        <button class="flowchart-toolbar-btn" data-action="done-lock" title="Lock and keep vector"><i class="fas fa-lock"></i> Done (Lock)</button>
                    </div>`;
                container.insertBefore(toolbar, container.firstChild);
                bindGoJSToolbarActions();
            }
            const keepActive = () => toolbar && toolbar.classList.add('active');
            diagram.addDiagramListener('InitialLayoutCompleted', keepActive);
            diagram.addDiagramListener('ObjectSingleClicked', keepActive);
            diagram.addDiagramListener('SelectionMoved', keepActive);
            diagram.addDiagramListener('LinkDrawn', keepActive);
            diagram.addDiagramListener('LinkRelinked', keepActive);
            diagram.addDiagramListener('BackgroundSingleClicked', keepActive);

            // Resize handle logic
            const handle = container.querySelector('.resize-handle');
            if (handle) {
                let startY = 0;
                let startH = 0;
                    const onMove = (ev) => {
                    const dy = ev.clientY - startY;
                    const newH = Math.max(240, startH + dy);
                    diagramDiv.style.height = newH + 'px';
                        if (paletteDiv) paletteDiv.style.height = newH + 'px';
                    const wrap = container;
                    const wrapMin = parseInt((wrap.style.minHeight || '420').replace('px',''), 10) || 420;
                    wrap.style.minHeight = Math.max(360, newH + 80) + 'px';
                };
                const onUp = () => {
                    document.removeEventListener('mousemove', onMove);
                    document.removeEventListener('mouseup', onUp);
                };
                handle.addEventListener('mousedown', (ev) => {
                    ev.preventDefault();
                    startY = ev.clientY;
                    startH = parseInt(diagramDiv.style.height || '340', 10) || 340;
                    document.addEventListener('mousemove', onMove);
                    document.addEventListener('mouseup', onUp);
                });
            }
        }
    </script>
    
    <!-- Paste Flowchart Modal -->
    <div id="pasteFlowchartModal" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title"><i class="fas fa-paste"></i> Paste Flowchart</div>
                <button class="toolbar-btn" id="closePasteModalBtn" style="padding:6px 10px;"><i class="fas fa-times"></i></button>
            </div>
            <div class="modal-body">
                <div id="pasteZone" class="paste-zone" tabindex="0">
                    <p>Paste an image here (Ctrl+V) or drag & drop an image.</p>
                </div>
                <div class="paste-preview" id="pastePreview" style="display:none;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn secondary" id="convertPastedBtn" disabled><i class="fas fa-project-diagram"></i> Convert</button>
                <button class="btn" id="insertPastedBtn" disabled><i class="fas fa-check"></i> Done</button>
            </div>
        </div>
    </div>

    <!-- draw.io modal removed -->
</body>
</html> 